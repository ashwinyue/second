# ============================================================
# DEAR Agent - Docker Compose 配置
# ============================================================

services:
  # PostgreSQL 数据库
  postgres:
    image: postgres:16-alpine
    container_name: dear-postgres
    ports:
      - "5432:5432"
    environment:
      - POSTGRES_USER=dear
      - POSTGRES_PASSWORD=dear_password
      - POSTGRES_DB=dear_agent
    volumes:
      - postgres-data:/var/lib/postgresql/data
    networks:
      - dear-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U dear -d dear_agent"]
      interval: 10s
      timeout: 5s
      retries: 5

  # MinIO 对象存储
  minio:
    image: minio/minio:latest
    container_name: dear-minio
    ports:
      - "9000:9000"   # API 端口
      - "9001:9001"   # Web 控制台
    environment:
      - MINIO_ROOT_USER=minioadmin
      - MINIO_ROOT_PASSWORD=minioadmin
    command: server /data --console-address ":9001"
    volumes:
      - minio-data:/data
    networks:
      - dear-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 10s
      retries: 3

  # 后端服务
  backend:
    build:
      context: .
      dockerfile: Dockerfile
      target: backend
    container_name: dear-backend
    ports:
      - "8001:8001"
    restart: unless-stopped
    environment:
      - ARK_API_KEY=${ARK_API_KEY}
      - VOLC_TTS_APPID=${VOLC_TTS_APPID}
      - VOLC_TTS_ACCESS_TOKEN=${VOLC_TTS_ACCESS_TOKEN}
      - LLM_MODEL=${LLM_MODEL:-doubao-Seed-1-8-251228}
      - LLM_TEMPERATURE=${LLM_TEMPERATURE:-0.7}
      - LLM_MAX_TOKENS=${LLM_MAX_TOKENS:-4000}
      - IMAGE_MODEL=${IMAGE_MODEL:-doubao-Seedream-3-0-T2I-250415}
      - IMAGE_SIZE=${IMAGE_SIZE:-1080x1920}
      - VIDEO_MODEL=${VIDEO_MODEL:-Doubao-Seedance-1-0-Pro-Fast-251015}
      - VIDEO_DURATION=${VIDEO_DURATION:-5.0}
      - TTS_VOICE=${TTS_VOICE:-zh_female_qingxin}
      - TTS_ENCODING=${TTS_ENCODING:-mp3}
      - MAX_CONCURRENT=${MAX_CONCURRENT:-5}
      - OUTPUT_DIR=/app/outputs
      - TEMP_DIR=/app/temp
      # MinIO 配置
      - MINIO_ENDPOINT=minio:9000
      - MINIO_ACCESS_KEY=minioadmin
      - MINIO_SECRET_KEY=minioadmin
      - MINIO_BUCKET=dear-assets
      - MINIO_USE_SSL=false
      # Docker 部署时使用主机网络可访问的地址
      - MINIO_PUBLIC_URL=${MINIO_PUBLIC_URL:-http://localhost:9000}
      # 数据库配置
      - DATABASE_URL=postgresql+asyncpg://dear:dear_password@postgres:5432/dear_agent
      - DATABASE_ECHO=false
    volumes:
      - ./outputs:/app/outputs
    networks:
      - dear-network
    depends_on:
      postgres:
        condition: service_healthy
      minio:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/api/v1/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # 前端服务
  frontend:
    build:
      context: .
      dockerfile: Dockerfile
      target: frontend
    container_name: dear-frontend
    ports:
      - "${FRONTEND_PORT:-3000}:80"
    restart: unless-stopped
    depends_on:
      backend:
        condition: service_healthy
    networks:
      - dear-network

networks:
  dear-network:
    driver: bridge

volumes:
  postgres-data:
  minio-data:
