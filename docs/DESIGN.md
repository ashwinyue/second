# DEAR Agent è®¾è®¡æ–‡æ¡£ v2.0

## é¡¹ç›®æ¦‚è¿°

**DEAR** = **D**igital **E**nlightenment & **A**rtistic **R**easoningï¼ˆæ•°å­—å¯è’™ä¸è‰ºæœ¯æ¨ç†ï¼‰

åŸºäº LangGraph çš„å“²å­¦ç§‘æ™®è§†é¢‘ç”Ÿæˆ Agentï¼Œå·¥ä½œæµï¼š**æ–‡æ¡ˆ â†’ å›¾åƒ â†’ è§†é¢‘ â†’ é…éŸ³**

**æ¶æ„ç‰¹ç‚¹**ï¼šä½¿ç”¨ SSEï¼ˆServer-Sent Eventsï¼‰æµå¼è¿”å›å®æ—¶è¿›åº¦ï¼Œæ— éœ€ä»»åŠ¡é˜Ÿåˆ—ç®¡ç†

---

## ä¸€ã€æ•´ä½“æ¶æ„

### 1.1 ç³»ç»Ÿæ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        FastAPI Web å±‚                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                â”‚
â”‚  â”‚ SSE API    â”‚  â”‚  Static    â”‚                                â”‚
â”‚  â”‚ /api/v1/   â”‚  â”‚  /outputs  â”‚                                â”‚
â”‚  â”‚ /generate  â”‚  â”‚            â”‚                                â”‚
â”‚  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                  â”‚
         â”‚ SSE æµ           â”‚ é™æ€æ–‡ä»¶
         â–¼                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    LangGraph å·¥ä½œæµå±‚                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                   StateGraph                              â”‚  â”‚
â”‚  â”‚                                                           â”‚  â”‚
â”‚  â”‚   [START]                                                  â”‚  â”‚
â”‚  â”‚      â”‚                                                     â”‚  â”‚
â”‚  â”‚      â–¼                                                     â”‚  â”‚
â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                             â”‚  â”‚
â”‚  â”‚   â”‚  init   â”‚ â†’ ç”Ÿæˆ style_seed                            â”‚  â”‚
â”‚  â”‚   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                                             â”‚  â”‚
â”‚  â”‚        â–¼                                                   â”‚  â”‚
â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                             â”‚  â”‚
â”‚  â”‚   â”‚ writer  â”‚ â†’ LLM ç”Ÿæˆç»“æ„åŒ–æ–‡æ¡ˆ                         â”‚  â”‚
â”‚  â”‚   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                                             â”‚  â”‚
â”‚  â”‚        â”‚                                                   â”‚  â”‚
â”‚  â”‚        â–¼                                                   â”‚  â”‚
â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚  â”‚
â”‚  â”‚   â”‚  route_images (Send å¹¶å‘åˆ†å‘)    â”‚                    â”‚  â”‚
â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚  â”‚
â”‚  â”‚        â”‚           â”‚           â”‚                            â”‚  â”‚
â”‚  â”‚        â–¼           â–¼           â–¼                            â”‚  â”‚
â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚  â”‚
â”‚  â”‚   â”‚  image  â”‚ â”‚  image  â”‚ â”‚  image  â”‚ ... (å¹¶å‘)            â”‚  â”‚
â”‚  â”‚   â”‚   _1    â”‚ â”‚   _2    â”‚ â”‚   _N    â”‚                     â”‚  â”‚
â”‚  â”‚   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                     â”‚  â”‚
â”‚  â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚  â”‚
â”‚  â”‚                      â–¼                                      â”‚  â”‚
â”‚  â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                              â”‚  â”‚
â”‚  â”‚              â”‚ aggregate_    â”‚                              â”‚  â”‚
â”‚  â”‚              â”‚   images      â”‚                              â”‚  â”‚
â”‚  â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                              â”‚  â”‚
â”‚  â”‚                      â”‚                                      â”‚  â”‚
â”‚  â”‚                      â–¼                                      â”‚  â”‚
â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚  â”‚
â”‚  â”‚   â”‚  route_videos (Send å¹¶å‘åˆ†å‘)    â”‚                    â”‚  â”‚
â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚  â”‚
â”‚  â”‚        â”‚           â”‚           â”‚                            â”‚  â”‚
â”‚  â”‚        â–¼           â–¼           â–¼                            â”‚  â”‚
â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚  â”‚
â”‚  â”‚   â”‚  video  â”‚ â”‚  video  â”‚ â”‚  video  â”‚ ... (å¹¶å‘)            â”‚  â”‚
â”‚  â”‚   â”‚   _1    â”‚ â”‚   _2    â”‚ â”‚   _N    â”‚                     â”‚  â”‚
â”‚  â”‚   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                     â”‚  â”‚
â”‚  â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚  â”‚
â”‚  â”‚                      â–¼                                      â”‚  â”‚
â”‚  â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                              â”‚  â”‚
â”‚  â”‚              â”‚ aggregate_    â”‚                              â”‚  â”‚
â”‚  â”‚              â”‚   videos      â”‚                              â”‚  â”‚
â”‚  â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                              â”‚  â”‚
â”‚  â”‚                      â”‚                                      â”‚  â”‚
â”‚  â”‚                      â–¼                                      â”‚  â”‚
â”‚  â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                              â”‚  â”‚
â”‚  â”‚              â”‚   compose     â”‚ â†’ FFmpeg åˆæˆè§†é¢‘ç‰‡æ®µ          â”‚  â”‚
â”‚  â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                              â”‚  â”‚
â”‚  â”‚                      â”‚                                      â”‚  â”‚
â”‚  â”‚                      â–¼                                      â”‚  â”‚
â”‚  â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                              â”‚  â”‚
â”‚  â”‚              â”‚   narrator    â”‚ â†’ TTS ç”Ÿæˆé…éŸ³               â”‚  â”‚
â”‚  â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                              â”‚  â”‚
â”‚  â”‚                      â”‚                                      â”‚  â”‚
â”‚  â”‚                      â–¼                                      â”‚  â”‚
â”‚  â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                              â”‚  â”‚
â”‚  â”‚              â”‚  add_audio    â”‚ â†’ FFmpeg é…éŸ³åˆ°è§†é¢‘         â”‚  â”‚
â”‚  â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                              â”‚  â”‚
â”‚  â”‚                      â”‚                                      â”‚  â”‚
â”‚  â”‚                      â–¼                                      â”‚  â”‚
â”‚  â”‚                   [END]                                    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                        â”‚
                                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        æœåŠ¡å±‚                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚   LLM    â”‚  â”‚  Image   â”‚  â”‚  Video   â”‚  â”‚   TTS    â”‚      â”‚
â”‚  â”‚ doubao   â”‚  â”‚seedream  â”‚  â”‚seedance  â”‚  â”‚WebSocket â”‚      â”‚
â”‚  â”‚   seed   â”‚  â”‚  t2i     â”‚  â”‚  fast    â”‚  â”‚  binary  â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 SSE æµå¼æ¶æ„

```
å‰ç«¯                    åç«¯
 â”‚                       â”‚
 â”œâ”€â”€ POST /api/v1/generate â”€â”€â†’  åˆ›å»ºä»»åŠ¡
 â”‚    â†â”€ SSE æµ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚     â”‚
 â”‚    event: init            â”‚     â”‚  è·å– task_id
 â”‚    event: progress        â”‚  â”Œâ”€â”€â”´â”€â”€â”  å®æ—¶è¿›åº¦
 â”‚    event: scene           â”‚  â”‚Langâ”‚  åœºæ™¯æ•°æ®
 â”‚    event: progress        â”‚  â”‚Graphâ”‚  (å›¾ç‰‡/è§†é¢‘ URL)
 â”‚    event: scene           â”‚  â””â”€â”€â”¬â”€â”€â”˜
 â”‚    ...                    â”‚     â”‚
 â”‚    event: done            â”‚     â”‚  æœ€ç»ˆè§†é¢‘ URL
 â”‚    data: {final_video_url}â”‚     â”‚
```

**SSE äº‹ä»¶ç±»å‹**ï¼š

| äº‹ä»¶ | æ•°æ® | è¯´æ˜ |
|------|------|------|
| `init` | `{task_id, topic}` | ä»»åŠ¡åˆå§‹åŒ– |
| `progress` | `{step, progress, message}` | è¿›åº¦æ›´æ–° |
| `scene` | `{scene_id, type, url}` | å›¾ç‰‡/è§†é¢‘ç”Ÿæˆå®Œæˆ |
| `done` | `{final_video_url}` | å®Œæˆ |
| `error` | `{message}` | é”™è¯¯ |

---

## äºŒã€å‰ç«¯æ¶æ„

### 2.1 æŠ€æœ¯æ ˆ

- **æ¡†æ¶**: React 18 + TypeScript + Vite
- **çŠ¶æ€ç®¡ç†**: React Hooks (useState, useCallback)
- **è·¯ç”±**: React Router DOM
- **æ•°æ®è·å–**: åŸç”Ÿ fetch + ReadableStream
- **UI ç»„ä»¶**: Radix UI + Tailwind CSS

### 2.2 API å±‚è®¾è®¡

```typescript
// src/lib/api.ts
export function generateVideoStream(
  request: GenerationRequest,
  handlers: SSEEventHandler
): AbortController

type SSEEventHandler = {
  onInit?: (event: SSEInitEvent) => void
  onProgress?: (event: SSEProgressEvent) => void
  onScene?: (event: SSESceneEvent) => void
  onDone?: (event: SSEDoneEvent) => void
  onError?: (event: SSEErrorEvent) => void
}
```

### 2.3 æ¶ˆæ¯æµè®¾è®¡

```typescript
interface ChatMessage {
  id: string
  role: "user" | "assistant" | "system"
  content: string
  timestamp: Date
  taskId?: string
  isStreaming?: boolean    // æ˜¯å¦æ­£åœ¨ç”Ÿæˆ
  progress?: number         // 0-1
  step?: StepType          // å½“å‰æ­¥éª¤
  scenes?: SceneInfo[]      // åœºæ™¯åˆ—è¡¨
  finalVideoUrl?: string    // æœ€ç»ˆè§†é¢‘
  error?: string            // é”™è¯¯ä¿¡æ¯
  abortController?: AbortController  // ç”¨äºå–æ¶ˆ
}
```

---

## ä¸‰ã€åç«¯æ¶æ„

### 3.1 æŠ€æœ¯æ ˆ

- **æ¡†æ¶**: FastAPI (Python 3.10+)
- **å·¥ä½œæµ**: LangGraph + LangChain
- **AI æœåŠ¡**: ç«å±±å¼•æ“ï¼ˆè±†åŒ…ï¼‰
- **å¹¶å‘**: asyncio + LangGraph Send

### 3.2 API ç«¯ç‚¹

| ç«¯ç‚¹ | æ–¹æ³• | åŠŸèƒ½ |
|------|------|------|
| `/api/v1/generate` | POST | SSE æµå¼ç”Ÿæˆè§†é¢‘ |
| `/api/v1/health` | GET | å¥åº·æ£€æŸ¥ |
| `/outputs/final/{filename}` | GET | è·å–è§†é¢‘æ–‡ä»¶ |

### 3.3 æ–‡ä»¶ç»“æ„

```
app/
â”œâ”€â”€ api/
â”‚   â”œâ”€â”€ main.py          # FastAPI åº”ç”¨å·¥å‚ï¼ˆç®€åŒ–ç‰ˆï¼‰
â”‚   â”œâ”€â”€ routes.py        # SSE æµå¼ç«¯ç‚¹
â”‚   â””â”€â”€ models.py        # æ•°æ®æ¨¡å‹
â”œâ”€â”€ workflow/
â”‚   â”œâ”€â”€ graph.py         # LangGraph å·¥ä½œæµ
â”‚   â””â”€â”€ nodes/           # å·¥ä½œæµèŠ‚ç‚¹
â”œâ”€â”€ services/            # å¤–éƒ¨æœåŠ¡
â”‚   â”œâ”€â”€ llm.py
â”‚   â”œâ”€â”€ image_gen.py
â”‚   â”œâ”€â”€ video_gen.py
â”‚   â””â”€â”€ tts.py
â”œâ”€â”€ state.py             # AgentState å®šä¹‰
â””â”€â”€ config.py            # é…ç½®ç®¡ç†
```

---

## å››ã€ç«å±±å¼•æ“ API åˆ†æ

### 4.1 API ç‰¹æ€§ä¸å¹¶å‘ç­–ç•¥

| API | æ¨¡å‹ ID | å¹¶å‘æ”¯æŒ | å…³é”®å‚æ•° | ç­–ç•¥ |
|-----|---------|---------|---------|------|
| æ–‡ç”Ÿå›¾ | `doubao-seedream-3-0-t2i-250415` | âœ… æ”¯æŒ | `seed` | Semaphore=5, ç»Ÿä¸€ seed |
| è§†é¢‘ç”Ÿæˆ | `doubao-seedance-1-0-pro-fast-251015` | âœ… æ”¯æŒ | è½®è¯¢ | Semaphore=3, å¼‚æ­¥è½®è¯¢ |
| LLM | `doubao-seed-1-8-251228` | âœ… æ”¯æŒ | temperature | æ ‡å‡†è°ƒç”¨ |
| TTS | - | WebSocket | é•¿è¿æ¥ | ä¸²è¡Œå¤„ç† |

### 4.2 å¹¶å‘æ§åˆ¶æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    å¹¶å‘æ§åˆ¶å±‚æ¬¡ç»“æ„                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  Level 1: LangGraph Send æ¥å£                              â”‚
â”‚  â”œâ”€ ä¸ºæ¯ä¸ªå›¾åƒ/è§†é¢‘ç”Ÿæˆä»»åŠ¡åˆ›å»ºç‹¬ç«‹çš„æ‰§è¡Œåˆ†æ”¯                â”‚
â”‚  â””â”€ ä»»åŠ¡ä¹‹é—´å®Œå…¨éš”ç¦»ï¼Œå•ä¸ªå¤±è´¥ä¸å½±å“å…¶ä»–                      â”‚
â”‚                                                             â”‚
â”‚  Level 2: asyncio.Semaphore                                â”‚
â”‚  â”œâ”€ é™åˆ¶åŒæ—¶è¿›è¡Œçš„ API è¯·æ±‚æ•°é‡                              â”‚
â”‚  â””â”€ å›¾åƒ: max_concurrent=5, è§†é¢‘: max_concurrent=3            â”‚
â”‚                                                             â”‚
â”‚  Level 3: RetryPolicy                                      â”‚
â”‚  â”œâ”€ èŠ‚ç‚¹çº§è‡ªåŠ¨é‡è¯• (3æ¬¡, æŒ‡æ•°é€€é¿)                          â”‚
â”‚  â””â”€ jitter=True é¿å…é›·å‡»ç¾¤æ•ˆåº”                               â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## äº”ã€å›¾åƒé£æ ¼ä¸€è‡´æ€§æ–¹æ¡ˆ

### 5.1 é£æ ¼è¦æ±‚

- **æç®€çº¿æ¡ç”»**
- **ç«æŸ´äºº**ï¼šå››è‚¢é»‘è‰²çº¿æ¡
- **é«˜é¥±å’Œè‰²**ã€**å¼ºå¯¹æ¯”è‰²**ã€**è‰²å—åˆ†æ˜**
- **æ‰å¹³åŒ–**ã€**å•è‰²èƒŒæ™¯**ã€**ç®€æ´æ„å›¾**

### 5.2 ä¸€è‡´æ€§ä¿è¯ç­–ç•¥

| ç­–ç•¥ | å®ç°æ–¹å¼ | ä¼˜å…ˆçº§ |
|-----|---------|-------|
| **ç»Ÿä¸€ seed** | æ‰€æœ‰å›¾åƒä½¿ç”¨ç›¸åŒ `seed` å‚æ•° | ğŸ”´ å¿…é¡» |
| **Prompt åç¼€** | æ¯ä¸ªæç¤ºè¯è¿½åŠ å›ºå®šé£æ ¼æè¿° | ğŸ”´ å¿…é¡» |
| **è‰²æ¿é”å®š** | åœ¨ prompt ä¸­æŒ‡å®šå…·ä½“ HEX è‰²å€¼ | ğŸŸ¡ æ¨è |
| **æ„å›¾è§„èŒƒ** | æŒ‰æƒ…ç»ªç±»å‹åˆ†é…æ„å›¾æ–¹å¼ | ğŸŸ¡ æ¨è |

### 5.3 Prompt æ¨¡æ¿

```
{åœºæ™¯æè¿°},

æç®€çº¿æ¡ç”»é£æ ¼ï¼Œç«æŸ´äººè§’è‰²å››è‚¢ä¸ºé»‘è‰²çº¿æ¡ï¼Œ
æ‰å¹³åŒ–è®¾è®¡ï¼Œå•è‰²èƒŒæ™¯ï¼Œç®€æ´æ„å›¾ï¼Œ
é«˜é¥±å’Œåº¦å¼ºå¯¹æ¯”è‰²å—åˆ†æ˜ï¼Œ
colors: #FF6B6B #4ECDC4 #FFE66D #F7F7F7 #1A1A1A
```

---

## å…­ã€LangGraph çŠ¶æ€è®¾è®¡

### 6.1 çŠ¶æ€å®šä¹‰

```python
class Scene(TypedDict):
    """å•ä¸ªåœºæ™¯"""
    id: int
    text: str
    type: str  # hook/theory/science/analogy/twist/sublime
    duration: float
    emotion: str
    image_prompt: str
    image_url: NotRequired[str]
    video_url: NotRequired[str]


class AgentState(TypedDict):
    """Agent ä¸»çŠ¶æ€"""
    # è¾“å…¥
    config: Required[dict]

    # å½“å‰æ­¥éª¤
    step: str

    # åœºæ™¯ï¼ˆç´¯åŠ ï¼‰
    scenes: NotRequired[list[Scene]]

    # é£æ ¼æ§åˆ¶
    style_seed: NotRequired[int]

    # è¿›åº¦
    completed_images: NotRequired[int]
    total_images: NotRequired[int]
    completed_videos: NotRequired[int]

    # ä¸­é—´äº§ç‰©
    composed_video_url: NotRequired[str]   # åˆæˆåçš„è§†é¢‘ï¼ˆæ— å£°ï¼‰
    audio_url: NotRequired[str]            # é…éŸ³éŸ³é¢‘

    # æœ€ç»ˆç»“æœ
    final_video_url: NotRequired[str]       # å¸¦é…éŸ³çš„æœ€ç»ˆè§†é¢‘

    # é”™è¯¯
    errors: NotRequired[list[str]]
```

---

## ä¸ƒã€ä¸æ—§æ¶æ„å¯¹æ¯”

### 7.1 æ¶æ„å˜æ›´

| ç»´åº¦ | æ—§æ¶æ„ (WebSocket) | æ–°æ¶æ„ (SSE) |
|------|-------------------|-------------|
| é€šä¿¡åè®® | WebSocket åŒå‘ | SSE å•å‘ |
| ä»»åŠ¡ç®¡ç† | TaskManager å•ä¾‹ | ç›´æ¥æµå¼è¿”å› |
| è¿æ¥ç®¡ç† | ConnectionManager | HTTP è¿æ¥æ±  |
| å®¢æˆ·ç«¯å¤æ‚åº¦ | éœ€è¦ä¸“ç”¨ WS ç±» | åŸç”Ÿ fetch |
| å‰ç«¯çŠ¶æ€ | éœ€è¦è½®è¯¢ä»»åŠ¡çŠ¶æ€ | å®æ—¶æ¥æ”¶äº‹ä»¶ |
| ä»£ç è¡Œæ•° | ~800 è¡Œ | ~400 è¡Œ |

### 7.2 ä¼˜åŠ¿

1. **æ›´ç®€å•**ï¼šæ— éœ€ä»»åŠ¡é˜Ÿåˆ—ç®¡ç†ï¼Œä»£ç æ›´å°‘
2. **æ›´å¯é **ï¼šSSE åŸºäº HTTPï¼Œè‡ªåŠ¨é‡è¿
3. **æ›´æ ‡å‡†**ï¼šæµè§ˆå™¨åŸç”Ÿæ”¯æŒï¼Œæ— éœ€é¢å¤–åº“
4. **æ›´æ˜“è°ƒè¯•**ï¼šå¯ç›´æ¥ç”¨ curl æµ‹è¯•

---

## å…«ã€é¡¹ç›®ç»“æ„

```
second/
â”œâ”€â”€ app/                      # Python åŒ…
â”‚   â”œâ”€â”€ state.py              # LangGraph çŠ¶æ€
â”‚   â”œâ”€â”€ config.py             # é…ç½®ç®¡ç†
â”‚   â”œâ”€â”€ style.py              # é£æ ¼ç®¡ç†
â”‚   â”œâ”€â”€ graph.py              # LangGraph å·¥ä½œæµ
â”‚   â”œâ”€â”€ nodes/                # èŠ‚ç‚¹å‡½æ•°
â”‚   â”œâ”€â”€ services/             # å¤–éƒ¨æœåŠ¡
â”‚   â””â”€â”€ api/                  # FastAPI å±‚
â”‚       â”œâ”€â”€ main.py           # FastAPI åº”ç”¨
â”‚       â”œâ”€â”€ routes.py         # SSE æµå¼è·¯ç”±
â”‚       â””â”€â”€ models.py         # è¯·æ±‚/å“åº”æ¨¡å‹
â”œâ”€â”€ outputs/                  # ç”Ÿæˆç»“æœ
â”‚   â”œâ”€â”€ images/
â”‚   â”œâ”€â”€ videos/
â”‚   â”œâ”€â”€ audio/
â”‚   â””â”€â”€ final/
â”œâ”€â”€ web/                      # React å‰ç«¯
â”‚   â””â”€â”€ src/
â”‚       â”œâ”€â”€ lib/
â”‚       â”‚   â”œâ”€â”€ api.ts        # SSE API å°è£…
â”‚       â”‚   â””â”€â”€ types.ts      # ç±»å‹å®šä¹‰
â”‚       â””â”€â”€ pages/
â”‚           â””â”€â”€ chat-interface.tsx  # å¯¹è¯ç•Œé¢
â”œâ”€â”€ docs/
â”‚   â””â”€â”€ DESIGN.md             # æœ¬æ–‡æ¡£
â”œâ”€â”€ pyproject.toml
â””â”€â”€ .env
```

---

## ä¹ã€å¾…ç¡®è®¤äº‹é¡¹

- [ ] è¾“å‡ºè§†é¢‘åˆ†è¾¨ç‡ï¼Ÿï¼ˆå»ºè®®ï¼š1080x1920 ç«–å±ï¼‰
- [ ] æ˜¯å¦éœ€è¦èƒŒæ™¯éŸ³ä¹ï¼Ÿï¼ˆé»˜è®¤ï¼šä¸éœ€è¦ï¼‰
- [ ] å•ä¸ªè§†é¢‘æœ€å¤§æ—¶é•¿ï¼Ÿï¼ˆå»ºè®®ï¼š60ç§’ï¼‰
- [ ] å¹¶å‘æ•°é‡é™åˆ¶ï¼Ÿï¼ˆå›¾åƒï¼š5ï¼Œè§†é¢‘ï¼š3ï¼‰
