# DEAR Agent 工作流设计文档

## 文档概述

本文档描述哲学科普视频生成 Agent 的完整工作流设计，包括内容生成、视觉生产、音视频合成等核心模块的设计思路和实现方案。

---

## 一、系统架构设计

### 1.1 分层架构

```
┌─────────────────────────────────────────────────────────────────┐
│                        FastAPI Web 层                          │
│  ┌────────────┐  ┌────────────┐  ┌────────────┐                │
│  │ REST API   │  │ WebSocket  │  │  Static    │                │
│  │ /api/v1/*  │  │ /ws/tasks  │  │  /outputs  │                │
│  └─────┬──────┘  └─────┬──────┘  └─────┬──────┘                │
└────────┼──────────────────┼──────────────────┼─────────────────────┘
         │                  │                  │
         ▼                  ▼                  ▼
┌─────────────────────────────────────────────────────────────────┐
│                       任务管理层                                │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  TaskManager (异步任务管理 + WebSocket 推送)              │   │
│  └─────────────────────────────────────────────────────────┘   │
└───────────────────────────────────────┬─────────────────────────┘
                                        │
                                        ▼
┌─────────────────────────────────────────────────────────────────┐
│                    内容生成引擎 (Core)                          │
│  ├─ 提示词组装模块                                              │
│  ├─ LLM调用层（火山引擎 doubao-seed）                          │
│  ├─ 输出解析器（文案+分镜+提示词分离）                           │
│  └─ 质量评估器（去AI味检测、节奏评分）                          │
├─────────────────────────────────────────────────────────────────┤
│                    视觉生产层 (Visual)                          │
│  ├─ 文生图API调度（火山引擎 seedream）                          │
│  ├─ 图像风格统一化（色调/构图约束）                              │
│  ├─ 视频生成API调度（火山引擎 seedance）                        │
│  └─ 分镜时序引擎（根据文案节奏自动对齐时长）                      │
├─────────────────────────────────────────────────────────────────┤
│                    音视频合成层 (Post)                          │
│  ├─ TTS引擎（情感配音/多音色选择）                               │
│  ├─ 视频合成（FFmpeg脚本）                                      │
│  ├─ 音视频混合（FFmpeg脚本）                                    │
│  └─ 封面生成（标题+最佳帧提取）                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 二、核心模块设计

### 2.1 提示词动态组装模块

**输入参数：**
- `topic`: 哲学主题
- `philosopher`: 绑定哲学家（叔本华/加缪/尼采等）
- `science_type`: 科学佐证类型（神经科学/量子物理/进化论）
- `style_preset`: 风格模板（暗黑治愈/理性冷峻/诗意浪漫）

**组装逻辑：**
```
基础模板 + 哲学家适配层 + 科学事实库 + 风格修饰器 = 最终提示词
```

**关键设计：**
- 建立**哲学家语料库**（经典论断、核心隐喻、常用悖论）
- 建立**科学事实库**（多巴胺机制、熵增定律、观察者效应等）
- 实现**风格迁移**：同一主题可输出"学术冷峻版"或"深夜emo版"

---

### 2.2 LLM输出结构化解析

**原始输出 → 结构化数据：**

```python
{
  "script": {
    "full_text": "完整文案",
    "sentences": [
      {
        "id": 1,
        "text": "单句文案",
        "type": "hook|theory|science|analogy|twist|sublime",
        "duration": 3.5,  # 根据字数和类型自动计算
        "emotion_tag": "困惑|顿悟|震撼|温柔"
      }
    ]
  },
  "storyboard": [
    {
      "sentence_id": 1,
      "prompt": "文生图提示词",
      "camera": "特写|中景|全景|推进",
      "lighting": "侧逆光|顶光|散射光",
      "symbol": "核心视觉符号",
      "color_palette": ["#0a1628", "#d4af37"]  # 主色+高光
    }
  ],
  "audio": {
    "bgm_mood": "钢琴叙事|弦乐渐强|电子氛围",
    "sound_effects": [{"trigger": "钟摆句", "type": "tick_tock"}]
  }
}
```

---

### 2.3 视觉风格约束引擎

**解决多图风格不一致问题：**

| 约束维度 | 实现方式 |
|---------|---------|
| **色调锁定** | 强制追加色彩代码到提示词后缀 |
| **构图规范** | 定义5种基础构图（中心对称/三分法/对角线/框架式/留白式），按句类型分配 |
| **人物一致性** | 统一 seed 参数 + 固定风格描述 |
| **光影统一** | 定义光源方向（侧逆光为主），禁止顶光/底光混用 |

**本项目风格要求：**
- **极简线条画**
- **火柴人**：四肢黑色线条
- **高饱和色**、**强对比色**、**色块分明**
- **扁平化**、**单色背景**、**简洁构图**

**Prompt 模板：**
```
{场景描述},

极简线条画风格，火柴人角色四肢为黑色线条，
扁平化设计，单色背景，简洁构图，
高饱和度强对比色块分明，
colors: #FF6B6B #4ECDC4 #FFE66D #F7F7F7 #1A1A1A
```

**色板定义：**
```python
MINIMALIST_PALETTE = {
    "primary": "#FF6B6B",      # 主色：红色系
    "secondary": "#4ECDC4",    # 辅色：青色系
    "accent": "#FFE66D",       # 强调色：黄色系
    "background": "#F7F7F7",   # 背景：浅灰
    "line": "#1A1A1A"          # 线条：近黑
}
```

---

### 2.4 节奏时序引擎

**根据文案自动计算分镜时长：**

```
时长 = 基础阅读时间(字数×0.3秒) + 情绪加权 + 转场缓冲

情绪加权：
- hook句: +0.5秒（让观众反应）
- 类比句: +1.0秒（画面需理解）
- 升华句: +2.0秒（留白沉浸）
- 转场缓冲: 0.3秒叠化
```

**输出：**
- 带时间码的 EDL（编辑决策列表）
- 直接导入剪映的 JSON 格式

---

### 2.5 质量评估与迭代

**自动化评分维度：**

| 维度 | 检测方法 | 阈值 |
|-----|---------|------|
| AI味浓度 | 规则匹配（"让我们"/"综上所述"）+ 困惑度检测 | <10% |
| 画面感密度 | 名词实体识别（每句具象物体数量） | ≥2个/句 |
| 节奏流畅度 | 句长标准差 + 尾韵检测 | 标准差<8 |
| 金句识别 | 比喻句/悖论句/排比句检测 | ≥3句/篇 |

**迭代策略：**
- 单项未达标 → 针对性重生成（仅修改失败部分）
- 多项未达标 → 切换风格模板重试
- 连续3次失败 → 标记人工审核

---

## 三、关键算法逻辑

### 3.1 哲学家-科学事实匹配算法

```
输入：哲学家名称
输出：推荐科学佐证类型

规则：
叔本华 → 神经科学（意志与脑区）/ 进化论（生命意志）
加缪  → 热力学（熵增）/ 量子物理（观测者效应）
尼采  → 基因学（权力意志的生物基础）/ 心理学（超人说与马斯洛需求）
```

### 3.2 情绪曲线规划算法

```
目标：确保视频情绪有起伏，避免平铺直叙

标准曲线：
困惑( hook ) → 沉重(理论) → 好奇(科学) → 共鸣(类比) → 释然(反转) → 震撼(升华)

检测：使用情感分析API标记每句情绪值，绘制曲线，偏离标准则调整措辞
```

### 3.3 视觉符号继承算法

```
确保核心隐喻贯穿全片：

初始化：从主题提取根隐喻（如"钟摆"）
每句生成时：检查是否可视觉化根隐喻的变体
- 能：使用变体（钟摆→秋千→心跳波纹→DNA双螺旋摆动）
- 不能：使用次级隐喻（光/水/道路）
```

---

## 四、扩展接口设计

预留以下扩展点，无需重构核心：

| 扩展点 | 接口设计 |
|-------|---------|
| 新LLM接入 | 统一`BaseLLMProvider`接口，实现`generate()`方法 |
| 新文生图API | 统一`BaseImageProvider`接口，实现`generate_batch()` |
| 新平台适配 | 统一`BasePublisher`接口，实现`upload()`和`analytics()` |
| 用户反馈学习 | 埋点数据 → 评分模型 → 自动调整提示词权重 |

---

## 五、开发优先级建议

```
Phase 1（MVP）：提示词组装 + LLM输出解析 + 基础视觉约束，输出结构化JSON
Phase 2（自动化）：完整图像生成 + 视频生成 + 节奏时序引擎
Phase 3（闭环）：质量评估 + 数据回流，自动优化
Phase 4（智能体）：多Agent协作（编剧Agent+导演Agent+运营Agent）
```

---

## 六、数据流与存储设计

```
用户请求
  │
  ▼
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│  提示词版本库  │◄────│  生成任务队列  │────►│  LLM响应缓存  │
│  (版本控制)   │     │  (Celery)   │     │  (避免重复调用) │
└─────────────┘     └─────────────┘     └─────────────┘
                              │
                              ▼
                    ┌─────────────────┐
                    │   结构化内容DB    │
                    │  (文案/分镜/参数)  │
                    └────────┬────────┘
                             │
               ┌──────────────┼──────────────┐
               ▼              ▼              ▼
         ┌─────────┐    ┌─────────┐    ┌─────────┐
         │ 素材资源库 │    │ 成品视频库 │    │ 数据反馈库 │
         │(图片/音频)│    │(MP4+元数据)│    │(播放数据) │
         └─────────┘    └─────────┘    └─────────┘
```
